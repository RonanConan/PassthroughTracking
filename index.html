<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3 Hand Tracking</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 10px;
            z-index: 100;
        }
        button {
            padding: 15px 30px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
        }
        #status {
            margin-top: 20px;
            font-size: 14px;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>Quest 3 Hand Tracking</h1>
        <button id="startButton">Start AR Session</button>
        <div id="status">Press P to start recording, S to save</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { VRButton } from 'three/addons/webxr/VRButton.js';

        let camera, scene, renderer;
        let isRecording = false;
        let recordingStartTime = 0;
        let leftHandData = [];
        let rightHandData = [];
        let hand1, hand2;

        init();

        function init() {
            // Scene
            scene = new THREE.Scene();

            // Camera
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 1.6, 0);

            // Renderer with transparent background for passthrough
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true  // CRITICAL: transparent background for passthrough
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Setup AR session
            document.getElementById('startButton').addEventListener('click', async () => {
                try {
                    const supported = await navigator.xr.isSessionSupported('immersive-ar');
                    if (!supported) {
                        alert('AR not supported');
                        return;
                    }

                    const session = await navigator.xr.requestSession('immersive-ar', {
                        optionalFeatures: ['hand-tracking', 'local-floor']
                    });

                    await renderer.xr.setSession(session);
                    document.getElementById('info').style.display = 'none';

                    // Get hand objects
                    hand1 = renderer.xr.getHand(0);
                    hand2 = renderer.xr.getHand(1);
                    scene.add(hand1);
                    scene.add(hand2);

                } catch (error) {
                    alert('Error: ' + error.message);
                    console.error(error);
                }
            });

            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                if (e.key.toLowerCase() === 'p') {
                    startRecording();
                } else if (e.key.toLowerCase() === 's') {
                    saveData();
                }
            });

            // Handle resize
            window.addEventListener('resize', onWindowResize);

            // Start animation loop
            renderer.setAnimationLoop(animate);
        }

        function animate() {
            if (!isRecording) {
                renderer.render(scene, camera);
                return;
            }

            const timestamp = Date.now() - recordingStartTime;

            // Track left hand
            const leftController = renderer.xr.getController(0);
            const leftHand = renderer.xr.getHand(0);
            
            if (leftHand && leftHand.joints && leftHand.joints['wrist']) {
                const wrist = leftHand.joints['wrist'];
                if (wrist.visible) {
                    leftHandData.push({
                        timestamp: timestamp,
                        x: wrist.position.x,
                        y: wrist.position.y,
                        z: wrist.position.z
                    });
                }
            }

            // Track right hand
            const rightHand = renderer.xr.getHand(1);
            
            if (rightHand && rightHand.joints && rightHand.joints['wrist']) {
                const wrist = rightHand.joints['wrist'];
                if (wrist.visible) {
                    rightHandData.push({
                        timestamp: timestamp,
                        x: wrist.position.x,
                        y: wrist.position.y,
                        z: wrist.position.z
                    });
                }
            }

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function startRecording() {
            isRecording = true;
            recordingStartTime = Date.now();
            leftHandData = [];
            rightHandData = [];
            console.log('Recording started');
        }

        function saveData() {
            if (!isRecording) return;
            
            isRecording = false;
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
            
            // Save left hand
            if (leftHandData.length > 0) {
                const leftCSV = generateCSV(leftHandData);
                downloadCSV(leftCSV, `${dateStr}_${timeStr}_left_hand.csv`);
            }
            
            // Save right hand
            if (rightHandData.length > 0) {
                const rightCSV = generateCSV(rightHandData);
                downloadCSV(rightCSV, `${dateStr}_${timeStr}_right_hand.csv`);
            }
            
            console.log('Data saved. Left: ' + leftHandData.length + ' points, Right: ' + rightHandData.length + ' points');
        }

        function generateCSV(data) {
            let csv = 'Timestamp,HandX,HandY,HandZ\n';
            data.forEach(point => {
                csv += `${point.timestamp},${point.x},${point.y},${point.z}\n`;
            });
            return csv;
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
